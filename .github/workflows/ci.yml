name: CI (docker-run Postgres)

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  test-and-coverage:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Start Postgres (docker run)
        run: |
          docker pull postgres:15
          # map container port to runner localhost; tests will use 127.0.0.1
          docker run --name ci-postgres -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=test_db -d -p 5432:5432 postgres:15

      - name: Wait for Postgres
        run: |
          python - <<'PY'
          import socket, time, sys
          host = "127.0.0.1"
          port = 5432
          deadline = time.time() + 120
          while time.time() < deadline:
              try:
                  with socket.create_connection((host, port), timeout=2):
                      print("Postgres is up")
                      sys.exit(0)
              except Exception as exc:
                  print("waiting for postgres:", exc)
                  time.sleep(1)
          print("timed out waiting for postgres", file=sys.stderr)
          sys.exit(1)
          PY

      - name: Install backend deps
        working-directory: app/backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run backend tests with coverage
        working-directory: app/backend
        env:
          PYTHONPATH: ${{ github.workspace }}/app/backend
          DATABASE_URL: postgresql+psycopg2://postgres:postgres@127.0.0.1:5432/test_db
        run: |
          mkdir -p reports
          pytest tests --junitxml=reports/junit.xml --cov=app --cov-report=xml:reports/coverage.xml

      - name: Stop Postgres container
        if: always()
        run: |
          docker stop ci-postgres || true
          docker rm ci-postgres || true

  frontend-typecheck:
    runs-on: ubuntu-latest
    needs: test-and-coverage
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install frontend deps (generate lockfile if missing)
        run: |
          if [ ! -f app/frontend/package-lock.json ]; then
            npm install --prefix app/frontend
          else
            npm ci --prefix app/frontend
          fi

      - name: Frontend typecheck & build
        run: |
          npm run typecheck --prefix app/frontend
          npm run build --prefix app/frontend
